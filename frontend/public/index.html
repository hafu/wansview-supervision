<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>wansview</title>
		<script type="text/javascript" src="https://www.google.com/jsapi"></script>
		<script src="js/jquery-1.11.1.min.js"></script>
		<script src="socket.io/socket.io.js"></script>
		<style>
body {
	text-align:center;
	font-family:monospace;
	margin:0;
	padding:0;
}
img {
	padding:0;
	margin:0;
	border:0;
	float:left;
}
#test {
	margin:auto;
	padding:0;
	overflow:hidden;
	background-color:green;
}

#sidebar {
	width:350px;
	float:left;
	background-color:red;
}

		</style>
	</head>
	<body>
		<div id="sidebar">Stats
			<div id="piechart"></div>
		</div>
		<div id="test"></div>

		<script>
//console.log($( window ).width());
/*
$( window ).resize(function() {
var window_width = $( window ).width();
var window_height = $( window ).height();
console.log('Window size: ' + window_width + 'x' + window_height);
});
 */

// <img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABA......" />
google.load('visualization', '1.0', {'packages':['corechart']});
google.setOnLoadCallback(pieChart);

function pieChart() {
	var data = new google.visualization.DataTable();
	data.addColumn('string', 'Country');
	data.addColumn('number', 'Count');

	var socket = io.connect("/stats-socket");
	socket.on("stats", function (msg) {
		var cnt = 0;
		for (i=0; i<msg.length; i++) {
			console.log(msg[i]);
			if (i < 20) {
				data.addRow([msg[i].country, parseInt(msg[i].count)]);
			}
			else {
				cnt += parseInt(msg[i].count); 
			}
		}
		var chart = new google.visualization.PieChart(document.getElementById('piechart'));
		 chart.draw(data);
	});
}

var imageCount = 0;
$( document ).ready(function() {
	console.log( "document loaded" );
	$("#test").append("<p>loading ...</p>");

	var socket = io.connect("/image-socket");
	$("#test").append("<p>sending resolution</p>");
	//socket.emit("resolution", {width: $( window ).width(), height: $( window ).height()});
	socket.emit("resolution", {width: $( window ).width() - $("#sidebar").width(), height: $( window ).height()});

	socket.on("loading", function (msg) {
		$("#test").append("<p>" + msg + "</p>");
	});

	socket.on("error", function (msg) {
		$("#test").append("<p style=\"color:red;\">" + msg + "</p>");
	});

	socket.on("progress", function (p) {
		console.log("progress: " + p);
		if ($("#progress").length) {
			$("#progress").text(p + " %");
		}
		else {
			$("#test").append("<p id=\"progress\">" + p + " %</p>");
		}

	});

	socket.on("images", function (data) {
		imageCount = data.images.length;
		$("#test").empty();
		$("#test").css("width", Math.floor(($( window ).width() - $("#sidebar").width()) / data.imagew) * data.imagew);
		//$("#test").css("width", Math.floor($( window ).width() / data.imagew) * data.imagew);
		$("#test").css("margin-top", ($( window ).height() - Math.floor($( window ).height() / data.imageh) * data.imageh) / 2);
		for (i=0; i<data.images.length; i++) {
			//console.log("image " + i + " data: " + data.images[i]);
			$("#test").append("<img id=\"img" + i + "\" src=\"data:image/jpeg;base64," + data.images[i] + "\" />");
		}
	});

	socket.on("newImage", function (data) {
		console.log("Got new Image");
		if (imageCount > 0 ) {
			var r = Math.floor(Math.random() * imageCount) + 1;
			console.log("updateing image: " + r);
			$("#img" + r).fadeOut(1000, function() {
				$(this).attr("src", "data:image/jpeg;base64," + data.image);
				$(this).load(function () {
					$(this).fadeIn(1000);
				});
			});
			//$("#img" + r).attr("src", "data:image/jpeg;base64," + data.image);
		}
	});
	
	

	/*
	$("#test").css("margin-top", $( window ).height() / 2);
	$("#test").append("loading ...");
	$.post("/getRandomImages", {width: $( window ).width(), height: $( window ).height()}, function (data) {
		if (data) {
			console.log('got data');
			console.log(data);
			if (data.error != null) {
				console.error(data.error);
				$("#test").empty();
				$("#test").append(data.error);
				$("#test").css("color", "red");
				return;
			}
			$("#test").empty();
			$("#test").css("width", Math.floor($( window ).width() / data.imagew) * data.imagew);
			$("#test").css("margin-top", ($( window ).height() - Math.floor($( window ).height() / data.imageh) * data.imageh) / 2);
			for (i=0; i<data.images.length; i++) {
				//console.log("image " + i + " data: " + data.images[i]);
				$("#test").append("<img src=\"data:image/jpeg;base64," + data.images[i] + "\" />");
			}
		}
	});
	var imgCount = Math.floor(($( window ).width() / 160)) * Math.floor(($( window ).height() / 120));
	console.log("images to load: " + imgCount);
	$.ajax({
		url: "/images/" + imgCount,
		dataType: "json",
		cache: false,
		success: function(data) {
			console.log('got data');
			console.log(data);
			if (data.error != null) {
				console.error(data.error);
				$("#test").empty();
				$("#test").append(data.error);
				$("#test").css("color", "red");
				return;
			}
			$("#test").empty();
			$("#test").css("width", Math.floor($( window ).width() / 160) * 160);
			$("#test").css("margin-top", ($( window ).height() - Math.floor($( window ).height() / 120) * 120) / 2);
			for (i=0; i<data.images.length; i++) {
				//console.log("image " + i + " data: " + data.images[i]);
				$("#test").append("<img src=\"data:image/jpeg;base64," + data.images[i] + "\" />");
			}
		},
		error: function(jqXHR, textStatus, errorThrown){
			console.error('failed to load data');
		}
	});
	*/

});

		/*
$( window ).load(function() {
	console.log( "window loaded" );
});
*/

		</script>


	</body>
</html>
